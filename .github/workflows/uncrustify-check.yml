name: Uncrustify Check

on:
  push

jobs:
  uncrustify-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    # - name: Cache dependencies
    #   uses: actions/cache@v2
    #   with:
    #     path: uncrustify-uncrustify-0.77.1/build
    #     key: uncrustify-build-${{ runner.os }}-v1

    - name: Set up Uncrustify
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://github.com/uncrustify/uncrustify/archive/uncrustify-0.77.1.tar.gz
        tar -xzvf uncrustify-0.77.1.tar.gz
        cd uncrustify-uncrustify-0.77.1
        mkdir build
        cd build
        cmake ..
        make
        sudo make install

    - name: Run Uncrustify Check
      run: |
        result=$(find . -type f \( -name "*.cpp" -o -name "*.hpp" \) -not -path "./uncrustify-uncrustify-0.77.1/*" -exec uncrustify --check -c uncrustify.cfg {} \; 2>&1)
        echo "$result" | grep -q "FAIL"
        grep -q "FAIL" "$result" && exit 1 || exit 0

        # if [ $? -eq 0 ]; then
        #   echo "Uncrustify check failed for the following files:"
        #   echo "$result" | grep "FAIL"
        #   exit 1
        # else
        #   echo "Uncrustify check passed for all files."
        #   exit 0
        # fi

    # find . -type f \( -name "*.cpp" -o -name "*.hpp" \) -not -path "./uncrustify-uncrustify-0.77.1/*" | xargs -I {} uncrustify --check -c uncrustify.cfg -l cpp {} | tee result.txt
    # grep -q "FAIL" result.txt && exit 1 || exit 0




